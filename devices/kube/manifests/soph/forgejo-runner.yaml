apiVersion: v1
kind: Namespace
metadata:
  name: forgejo-runner
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: docker-daemon-config
  namespace: forgejo-runner
data:
  daemon.json: |
    {
      "ipv6": true,
      "fixed-cidr-v6": "2a02:810d:6f83:ad12:34::/112",
      "debug": true,
      "features": {
        "containerd-snapshotter": true
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: forgejo-runner
data:
  config.yaml: |
    runner:
      envs:
        DOCKER_HOST: tcp://dind_container.docker.internal:2375

    container:
      # Specifies the network to which the container will connect.
      # Could be host, bridge or the name of a custom network.
      # If it's empty, create a network automatically.
      network: ""
      # Whether to create networks with IPv6 enabled. Requires the Docker daemon to be set up accordingly.
      # Only takes effect if "network" is set to "".
      enable_ipv6: true

      docker_host: 'tcp://[::1]:2375'

      options: '--add-host=dind_container.docker.internal:host-gateway --device /dev/kvm --cap-add=ALL'

    cache:
      enabled: true
      dir: "/cache"
      # Use the LAN IP obtained in step 1
      host: "dind_container.docker.internal"
      # Use the port number obtained in step 2
      port: 0
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: forgejo-runner-cache-pvc
  namespace: forgejo-runner
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 32Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: forgejo-runner
  namespace: forgejo-runner
spec:
  serviceName: forgejo-runner
  selector:
    matchLabels:
      app: forgejo-runner
  template:
    metadata:
      labels:
        app: forgejo-runner
    spec:
      initContainers:
        - name: fix-perms
          image: busybox
          command: ["sh", "-c", "chown -R 1000:1000 /data"]
          volumeMounts:
            - name: runner-data
              mountPath: /data
        - name: setup-runner
          image: code.forgejo.org/forgejo/runner:11
          command:
            - /bin/bash
            - -c
            - |
              set -e
              if [ ! -f /data/.runner ]; then
                echo "No config found â€” registering runner..."
                forgejo-runner register --no-interactive --name "ex-machina-runner-$(hostname)" --instance https://xn--55q89qy6p.com --token ${FORGEJO_REGISTRATION_TOKEN}
              else
                echo "Config already exists, skipping registration."
              fi
          env:
            - name: FORGEJO_REGISTRATION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: forgejo-runner-secret
                  key: token
          volumeMounts:
            - name: runner-data
              mountPath: /data
      containers:
        - name: dind
          image: docker:dind
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN"]
          command: ["dockerd", "-H", "tcp://[::]:2375", "--tls=false"]
          volumeMounts:
            - name: daemon-config
              mountPath: /etc/docker/daemon.json
              subPath: daemon.json
            - name: docker-data
              mountPath: /var/lib/docker
          ports:
            - containerPort: 2375
          resources: {}
        - name: forgejo-runner
          image: code.forgejo.org/forgejo/runner:11
          securityContext:
            privileged: true
            capabilities:
              add: ["ALL"]
          command: ["/bin/forgejo-runner", "daemon", "--config", "/config.yaml"]
          env:
            - name: DOCKER_HOST
              value: tcp://[::1]:2375
          volumeMounts:
            - name: runner-data
              mountPath: /data
            - name: runner-cache
              mountPath: /cache
            - name: runner-config
              mountPath: /config.yaml
              subPath: config.yaml
            - name: kvm-device
              mountPath: /dev/kvm
          resources: {}
      restartPolicy: Always
      dnsConfig:
        nameservers:
          - 2a01:4f8:c2c:123f::1
          - 2a00:1098:2b::1
      volumes:
        - name: runner-config
          configMap:
            name: runner-config
        - name: kvm-device
          hostPath:
            path: /dev/kvm
            type: CharDevice
        - name: daemon-config
          configMap:
            name: docker-daemon-config
        - name: runner-cache
          persistentVolumeClaim:
            claimName: forgejo-runner-cache-pvc
  volumeClaimTemplates:
    - metadata:
        name: runner-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: docker-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 16Gi
